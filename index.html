<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Izlo≈æba protesta u Srbiji ‚Äî poslednjih 9 meseci</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
</head>
<body>
<header>
  <h1>IZLO≈ΩBA PROTESTA U SRBIJI</h1>
  <p class="sub">Novembar 2024 ‚Üí Avgust 2025 ¬∑ verifikovani dogaƒëaji i izvori</p>
</header>

<section class="controls">
  <div class="rangewrap">
    <label for="monthSlider">Do meseca:</label>
    <input type="range" id="monthSlider" min="0" max="9" value="9" step="1">
    <span id="monthLabel">Avg 2025</span>
  </div>
  <div class="filters">
    <select id="cityFilter"><option value="">Sve lokacije</option></select>
    <select id="typeFilter">
      <option value="">Sve vrste</option>
      <option value="mar≈°">Mar≈°</option>
      <option value="blokada">Blokada</option>
      <option value="vigilija">Vigilija</option>
      <option value="sukobi">Sukobi</option>
      <option value="umetnost">Umetnost/izlo≈æba</option>
      <option value="institucije">Institucije</option>
      <option value="meƒëunarodno">Meƒëunarodno</option>
      <option value="kontraskup">Kontraskup</option>
    </select>
    <input type="search" id="searchBox" placeholder="Pretraga‚Ä¶">
  </div>
</section>

<section class="mapwrap">
  <div id="map"></div>
  <div class="legend" id="legend"></div>
</section>

<main id="timeline"><div class="empty">Uƒçitavanje podataka‚Ä¶</div></main>
<footer><p>Javna, ƒçitljiva, arhivska izlo≈æba. Linkovi vode ka izvorima. ¬© Zajednica.</p></footer>

<div id="lightbox" class="lightbox hidden">
  <button class="close" id="lbClose" aria-label="Zatvori">√ó</button>
  <img id="lbImg" alt="fotografija">
  <div class="lbCaption" id="lbCap"></div>
  <button class="nav prev" id="lbPrev" aria-label="Prethodna">‚Äπ</button>
  <button class="nav next" id="lbNext" aria-label="Sledeƒáa">‚Ä∫</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const MONTHS = ['Nov 2024','Dec 2024','Jan 2025','Feb 2025','Mar 2025','Apr 2025','Maj 2025','Jun 2025','Jul 2025','Avg 2025'];
const COLORS = { "mar≈°":"#2a5f36","blokada":"#6a4b2d","vigilija":"#5b5a2a","sukobi":"#6f2a2a","umetnost":"#6a2a6a","institucije":"#2a5a6f","meƒëunarodno":"#2a356f","kontraskup":"#5a2a2a" };
const monthSlider = document.getElementById('monthSlider');
const monthLabel = document.getElementById('monthLabel');
const cityFilter = document.getElementById('cityFilter');
const typeFilter = document.getElementById('typeFilter');
const searchBox = document.getElementById('searchBox');
const timeline = document.getElementById('timeline');
const legend = document.getElementById('legend');
let MAP, CLUSTER, PROTESTS=[], CURRENT_LIGHTBOX=[], LB_INDEX=0;

function initLegend(){ legend.innerHTML = Object.entries(COLORS).map(([k,c])=>`<span><i style="background:${c}"></i>${k}</span>`).join(''); }
function initMap(){
  MAP = L.map('map',{scrollWheelZoom:false}).setView([44.8,20.46],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(MAP);
  CLUSTER = L.markerClusterGroup(); MAP.addLayer(CLUSTER);
}
function markerIcon(color){
  const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='30' height='42'><path d='M15 0C7 0 1 6 1 14c0 10 14 28 14 28s14-18 14-28C29 6 23 0 15 0z' fill='${color}'/><circle cx='15' cy='14' r='6' fill='white'/></svg>`);
  return L.icon({ iconUrl:`data:image/svg+xml,${svg}`, iconSize:[30,42], iconAnchor:[15,42], popupAnchor:[0,-36]});
}
function refreshMap(events){
  CLUSTER.clearLayers();
  events.forEach(e=>{
    if (!e.lat || !e.lng) return;
    const m = L.marker([e.lat,e.lng], {icon: markerIcon(COLORS[e.type]||'#324a6f')})
      .bindPopup(`<b>${e.title}</b><br>${new Date(e.date).toLocaleDateString('sr-RS')} ‚Äî ${e.city}`);
    CLUSTER.addLayer(m);
  });
  if (CLUSTER.getLayers().length){ MAP.fitBounds(CLUSTER.getBounds().pad(0.2)); }
}
function fmtDate(d){ const dt = new Date(d); return dt.toLocaleDateString('sr-RS', {year:'numeric', month:'short', day:'2-digit'}); }
function imgTag(src, cap=''){ return `<figure><img src="${src}" loading="lazy" data-cap="${cap}"><figcaption>${cap||''}</figcaption></figure>`; }
function card(e, index){
  const thumbs = (e.photos?.length ? e.photos : (e.thumbnail?[e.thumbnail]:[])).slice(0,6).map((u,i)=>imgTag(u, e.photo_captions?.[i]||'')).join('');
  return `
    <article class="card ${e.type}">
      <div class="date">${fmtDate(e.date)}</div>
      <h3>${e.title}</h3>
      <div class="meta"><span>üìç ${e.city}</span><span class="tag">${e.type}</span></div>
      <p class="desc">${e.description}</p>
      ${e.demands?.length ? '<ul class="demands">'+e.demands.map(d=>'<li>'+d+'</li>').join('')+'</ul>' : ''}
      ${thumbs ? '<div class="photos" data-index="'+index+'">'+thumbs+'</div>' : ''}
      <div class="links">${e.sources.map(s=>`<a href="${s.url}" target="_blank" rel="noopener">${s.name}</a>`).join('')}</div>
    </article>`;
}
function buildCityFilter(){
  cityFilter.innerHTML = '<option value="">Sve lokacije</option>';
  Array.from(new Set(PROTESTS.map(e => e.city))).sort().forEach(c => {
    const o = document.createElement('option'); o.value=c; o.textContent=c; cityFilter.appendChild(o);
  });
}
function monthCutoff(idx){ const base = new Date('2024-11-01T00:00:00Z'); base.setUTCMonth(base.getUTCMonth()+idx+1); return base; }
function openLightbox(images, startIdx=0){
  const lb = document.getElementById('lightbox'), img = document.getElementById('lbImg'), cap = document.getElementById('lbCap');
  CURRENT_LIGHTBOX = images; LB_INDEX = startIdx;
  function show(i){ LB_INDEX = (i+CURRENT_LIGHTBOX.length)%CURRENT_LIGHTBOX.length; const el = CURRENT_LIGHTBOX[LB_INDEX]; img.src = el.src; cap.textContent = el.getAttribute('data-cap') || ''; }
  document.getElementById('lbPrev').onclick = () => show(LB_INDEX-1);
  document.getElementById('lbNext').onclick = () => show(LB_INDEX+1);
  document.getElementById('lbClose').onclick = () => lb.classList.add('hidden');
  lb.onclick = (e)=>{ if(e.target===lb) lb.classList.add('hidden'); };
  lb.classList.remove('hidden'); show(LB_INDEX);
}
function bindLightbox(){
  document.querySelectorAll('.photos').forEach(grid => {
    const imgs = Array.from(grid.querySelectorAll('img'));
    imgs.forEach((im, i) => im.addEventListener('click', ()=> openLightbox(imgs, i)));
  });
}
function render(){
  if (!PROTESTS.length){ timeline.innerHTML = '<div class="empty">Nema podataka za prikaz.</div>'; return; }
  const idx = parseInt(monthSlider.value,10);
  monthLabel.textContent = MONTHS[idx];
  const limit = monthCutoff(idx);
  const q = (searchBox.value||'').toLowerCase().trim();
  const csel = cityFilter.value;
  const tsel = typeFilter.value;
  const filtered = PROTESTS.filter(e => {
    if (new Date(e.date) > limit) return false;
    if (csel && e.city !== csel) return false;
    if (tsel && e.type !== tsel) return false;
    if (q){ const hay=(e.title+' '+e.description+' '+(e.demands||[]).join(' ')).toLowerCase(); if (!hay.includes(q)) return false; }
    return true;
  }).sort((a,b)=>new Date(a.date)-new Date(b.date));
  timeline.innerHTML = filtered.map((e,i)=>card(e,i)).join('');
  bindLightbox();
  refreshMap(filtered);
}
async function boot(){
  initLegend(); initMap();
  try { const res = await fetch('data/protests.json',{cache:'no-store'}); PROTESTS = await res.json(); }
  catch (e) { timeline.innerHTML = '<div class="empty">Gre≈°ka pri uƒçitavanju podataka.</div>'; return; }
  buildCityFilter();
  monthSlider.addEventListener('input', render);
  cityFilter.addEventListener('change', render);
  typeFilter.addEventListener('change', render);
  searchBox.addEventListener('input', render);
  render();
}
boot();
</script>
</body>
</html>
